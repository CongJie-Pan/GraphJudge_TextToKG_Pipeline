<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è­˜åœ–è­œå¯è¦–åŒ–å™¨ - ç°¡æ˜“é è¦½</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Check if D3.js loaded successfully
        function checkD3() {
            if (typeof d3 === 'undefined') {
                console.error('âŒ D3.js failed to load, trying fallback...');
                
                // Try alternative CDN
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/d3@7';
                script.onload = function() {
                    console.log('âœ… D3.js fallback loaded successfully');
                    if (typeof d3 !== 'undefined') {
                        initWhenReady();
                    } else {
                        showD3Error();
                    }
                };
                script.onerror = function() {
                    console.error('âŒ D3.js fallback also failed to load');
                    showD3Error();
                };
                document.head.appendChild(script);
                return false;
            }
            console.log('âœ… D3.js loaded successfully');
            return true;
        }
        
        function showD3Error() {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #dc3545;">
                    <h2>âŒ D3.js åº«è¼‰å…¥å¤±æ•—</h2>
                    <p>è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–å˜—è©¦ä»¥ä¸‹è§£æ±ºæ–¹æ¡ˆï¼š</p>
                    <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                        <li>ç¢ºä¿ç¶²è·¯é€£æ¥æ­£å¸¸</li>
                        <li>æª¢æŸ¥é˜²ç«ç‰†æˆ–ä»£ç†è¨­ç½®</li>
                        <li>å˜—è©¦é‡æ–°æ•´ç†é é¢</li>
                        <li>è¯ç¹«ç³»çµ±ç®¡ç†å“¡</li>
                    </ul>
                </div>
            `;
        }
        
        function initWhenReady() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startApp);
            } else {
                startApp();
            }
        }
        
        function startApp() {
            console.log('ğŸš€ Simple viewer - DOM loaded, starting initialization...');
            
            try {
                init();
            } catch (error) {
                console.error('âŒ Simple viewer initialization failed:', error);
                console.error('Error details:', error.stack);
                
                // Show error message to user
                const statsElement = document.getElementById('stats');
                if (statsElement) {
                    statsElement.textContent = `åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`;
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }
        
        .graph-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 0 auto;
            max-width: 1400px;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .controls button {
            margin: 0 5px;
            padding: 5px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .stats {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node:hover {
            stroke: #333;
            stroke-width: 3px;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1px;
        }
        
        .node-label {
            font-size: 8px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>çŸ¥è­˜åœ–è­œå¯è¦–åŒ–å™¨ - ç°¡æ˜“é è¦½</h1>
        <p id="file-info">è¼‰å…¥ä¸­...</p>
    </div>
    
    <div class="graph-container">
        <div class="controls">
            <button onclick="restartSimulation()">é‡æ–°å•Ÿå‹•</button>
            <button onclick="pauseResume()">æš«åœ/ç¹¼çºŒ</button>
            <button onclick="centerView()">ç½®ä¸­è¦–åœ–</button>
        </div>
        
        <div class="stats" id="stats">è¼‰å…¥ä¸­...</div>
        
        <div id="graph" style="width: 100%; height: 600px;"></div>
    </div>

    <script>
        // Global variables for the visualization
        let simulation;
        let nodes = [];
        let links = [];
        let svg;
        let isPaused = false;
        
        // Color scheme for different entity types
        const colorScheme = {
            person: '#ff7f0e',
            location: '#2ca02c',
            literature: '#9467bd',
            concept: '#d62728',
            other: '#1f77b4'
        };
        
        // Initialize the visualization
        function init() {
            console.log('ğŸš€ Simple viewer - Initializing visualizer...');
            
            try {
                // Set up SVG
                console.log('ğŸ“ Setting up SVG container...');
                const container = d3.select('#graph');
                
                if (container.empty()) {
                    console.error('âŒ Cannot find #graph container element');
                    throw new Error('Graph container element does not exist');
                }
                
                const width = container.node().getBoundingClientRect().width;
                const height = 600;
                console.log(`ğŸ“ Container dimensions: ${width} x ${height}`);
                
                svg = container.append('svg')
                    .attr('width', width)
                    .attr('height', height);
                
                console.log('âœ… SVG element created successfully');
                
                // Add zoom and pan functionality
                console.log('ğŸ” Adding zoom and pan functionality...');
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', function(event) {
                        svg.selectAll('g').attr('transform', event.transform);
                    });
                
                svg.call(zoom);
                console.log('âœ… Zoom functionality added successfully');
                
                // Create tooltip
                console.log('ğŸ’¬ Creating tooltip...');
                d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0);
                console.log('âœ… Tooltip created successfully');
                
                // Load and process data
                console.log('ğŸ“Š Starting data loading...');
                loadData();
                
            } catch (error) {
                console.error('âŒ Initialization failed:', error);
                throw error;
            }
        }
        
        // Load JSON data and create visualization
        async function loadData() {
            console.log('ğŸ”„ Simple viewer - Starting data loading...');
            document.getElementById('stats').textContent = 'æ­£åœ¨è¼‰å…¥æ•¸æ“š...';
            
            try {
                // Check if specific file is requested via URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const selectedFile = urlParams.get('file');
                
                console.log(`ğŸ“ Requested file: ${selectedFile || 'default file'}`);
                
                // Construct API URL with file parameter if specified
                const apiUrl = selectedFile ? `/api/graph-data?file=${encodeURIComponent(selectedFile)}` : '/api/graph-data';
                console.log(`ğŸ“¡ API URL: ${apiUrl}`);
                
                console.log('ğŸ“ Sending API request...');
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('âœ… API response successful, parsing JSON...');
                const data = await response.json();
                console.log('ğŸ“Š Received data:', {
                    entities: data.entities?.length || 0,
                    relationships: data.relationships?.length || 0,
                    fixes: data.fixes_applied || 0
                });
                
                // Check if this is an empty graph response
                if (data.empty_graph) {
                    // Handle empty graph case
                    document.getElementById('file-info').textContent = `çŸ¥è­˜åœ–è­œå¯è¦–åŒ– (ç²¾ç°¡ç‰ˆ) - æš«ç„¡è³‡æ–™`;
                    document.getElementById('stats').textContent = `æ²’æœ‰å¯ç”¨çš„åœ–è­œè³‡æ–™ã€‚è«‹ä¸Šå‚³ JSON æ ¼å¼çš„åœ–è­œæª”æ¡ˆä¾†é–‹å§‹è¦–è¦ºåŒ–ã€‚`;
                    
                    // Show empty state message in the visualization area
                    svg.selectAll('*').remove();
                    const width = parseInt(svg.attr('width'));
                    const height = parseInt(svg.attr('height'));
                    
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .attr('font-family', 'Arial, sans-serif')
                        .attr('font-size', '18px')
                        .attr('fill', '#666')
                        .text('æš«ç„¡åœ–è­œè³‡æ–™');
                    
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2 + 30)
                        .attr('text-anchor', 'middle')
                        .attr('font-family', 'Arial, sans-serif')
                        .attr('font-size', '14px')
                        .attr('fill', '#999')
                        .text('è«‹ä¸Šå‚³ JSON æ ¼å¼çš„åœ–è­œæª”æ¡ˆä¾†é–‹å§‹è¦–è¦ºåŒ–');
                    
                    console.log('âœ… Empty graph state displayed');
                    return;
                }
                
                // Update file info display
                const sourceFile = data.source_file || 'é è¨­æª”æ¡ˆ';
                document.getElementById('file-info').textContent = `åŸºæ–¼ ${sourceFile} çš„çŸ¥è­˜åœ–è­œå¯è¦–åŒ– (ç²¾ç°¡ç‰ˆ)`;
                console.log(`ğŸ“ Updated file info display: ${sourceFile}`);
                
                // Check if server applied fixes
                if (data.fixes_applied > 0) {
                    console.log(`âœ… Server automatically fixed ${data.fixes_applied} missing entities`);
                    console.log('Fixed entities:', data.missing_entities_found);
                    
                    // Show notification to user
                    document.getElementById('stats').textContent = `æ­£åœ¨è™•ç†æ•¸æ“š... (å·²è‡ªå‹•ä¿®å¾© ${data.fixes_applied} å€‹æ•¸æ“šä¸ä¸€è‡´å•é¡Œ)`;
                }
                
                console.log('ğŸ”§ Starting data processing...');
                processData(data);
                
                console.log('ğŸ¨ Starting visualization creation...');
                createVisualization();
                
                console.log('ğŸ“Š Updating statistics...');
                updateStats();
                
                console.log('âœ… Simple viewer loading completed!');
                
            } catch (error) {
                console.error('âŒ Simple viewer loading error:', error);
                console.error('Error details:', error.stack);
                document.getElementById('stats').textContent = `è¼‰å…¥å¤±æ•—ï¼š${error.message}`;
            }
        }
        
        // Process raw data into visualization format
        function processData(rawData) {
            console.log('ğŸ”§ Starting raw data processing...');
            console.log('ğŸ“Š Raw data structure:', {
                hasEntities: !!rawData.entities,
                hasRelationships: !!rawData.relationships,
                entitiesType: typeof rawData.entities,
                relationshipsType: typeof rawData.relationships,
                entitiesLength: rawData.entities?.length,
                relationshipsLength: rawData.relationships?.length
            });
            
            if (!rawData.entities || !Array.isArray(rawData.entities)) {
                console.error('âŒ Invalid entities data:', rawData.entities);
                throw new Error('Entity data format error');
            }
            
            if (!rawData.relationships || !Array.isArray(rawData.relationships)) {
                console.error('âŒ Invalid relationships data:', rawData.relationships);
                throw new Error('Relationship data format error');
            }
            
            console.log('âœ… Data format validation passed');
            
            // Create nodes from entities
            console.log('ğŸ”¨ Creating node data...');
            nodes = rawData.entities.map((entity, index) => {
                const node = {
                    id: entity,
                    name: entity,
                    type: classifyEntity(entity),
                    group: Math.floor(index / 50) // Group for force layout
                };
                
                if (index < 5) { // Log detailed info for first 5 nodes only
                    console.log(`  Node ${index + 1}: ${entity} (type: ${node.type})`);
                }
                
                return node;
            });
            
            console.log(`âœ… Successfully created ${nodes.length} nodes`);
            
            // Create links from relationships
            console.log('ğŸ”— Creating relationship data...');
            let validLinks = 0;
            let invalidLinks = 0;
            
            links = rawData.relationships.map((rel, index) => {
                const parts = rel.split(' - ');
                if (parts.length >= 3) {
                    const link = {
                        source: parts[0],
                        target: parts[2],
                        relationship: parts[1]
                    };
                    
                    if (index < 5) { // Log detailed info for first 5 relationships only
                        console.log(`  Relationship ${index + 1}: ${link.source} -> ${link.target} (${link.relationship})`);
                    }
                    
                    validLinks++;
                    return link;
                } else {
                    console.warn(`âš ï¸ Invalid relationship format: ${rel}`);
                    invalidLinks++;
                    return null;
                }
            }).filter(link => link !== null);
            
            console.log(`âœ… Successfully created ${links.length} valid relationships (invalid: ${invalidLinks})`);
            console.log(`ğŸ”§ Data processing completed: ${nodes.length} nodes, ${links.length} relationships`);
        }
        
        // Classify entities for color coding
        function classifyEntity(entity) {
            if (entity.includes('éš±') || entity.includes('æ‘') || entity.includes('è‹±è“®') || 
                entity.includes('å°æ°') || entity.includes('æ›¹é›ªèŠ¹')) {
                return 'person';
            }
            if (entity.includes('å»Ÿ') || entity.includes('å±±') || entity.includes('å³°') || 
                entity.includes('å··') || entity.includes('é–€') || entity.includes('äº¬åŸ')) {
                return 'location';
            }
            if (entity.includes('ã€Š') && entity.includes('ã€‹')) {
                return 'literature';
            }
            if (entity.includes('å¤¢') || entity.includes('æƒ…') || entity.includes('è©©') ||
                entity.includes('åŠŸå') || entity.includes('å¯Œè²´')) {
                return 'concept';
            }
            return 'other';
        }
        
        // Create the main visualization
        function createVisualization() {
            console.log('ğŸ¨ Starting visualization creation...');
            
            const width = parseInt(svg.attr('width'));
            const height = parseInt(svg.attr('height'));
            console.log(`ğŸ“ Canvas dimensions: ${width} x ${height}`);
            
            if (!nodes || nodes.length === 0) {
                console.error('âŒ Node data is empty, cannot create visualization');
                throw new Error('Node data is empty');
            }
            
            if (!links || links.length === 0) {
                console.error('âŒ Relationship data is empty, cannot create visualization');
                throw new Error('Relationship data is empty');
            }
            
            console.log(`ğŸ”§ Preparing to create force-directed graph: ${nodes.length} nodes, ${links.length} relationships`);
            
            try {
                // Clear any existing visualization
                svg.selectAll('*').remove();
                console.log('ğŸ§¹ Cleared old visualization elements');
                
                // Initialize force simulation
                console.log('âš¡ Initializing force simulation...');
                simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(links)
                        .id(d => d.id)
                        .distance(60)
                        .strength(0.5)
                    )
                    .force('charge', d3.forceManyBody()
                        .strength(-100)
                        .distanceMax(200)
                    )
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(15));
                
                console.log('âœ… Force simulation initialized successfully');
                
                // Create link elements
                console.log('ğŸ”— Creating relationship visualization elements...');
                const linkElements = svg.append('g')
                    .attr('class', 'links')
                    .selectAll('line')
                    .data(links)
                    .enter().append('line')
                    .attr('class', 'link');
                
                console.log(`âœ… Successfully created ${linkElements.size()} relationship lines`);
                
                // Create node elements
                console.log('â­• Creating node visualization elements...');
                const nodeElements = svg.append('g')
                    .attr('class', 'nodes')
                    .selectAll('circle')
                    .data(nodes)
                    .enter().append('circle')
                    .attr('class', 'node')
                    .attr('r', d => Math.max(4, Math.min(12, d.name.length)))
                    .style('fill', d => colorScheme[d.type] || colorScheme.other)
                    .call(createDragBehavior())
                    .on('mouseover', showTooltip)
                    .on('mouseout', hideTooltip);
                
                console.log(`âœ… Successfully created ${nodeElements.size()} node circles`);
                
                // Create label elements (only for important nodes)
                console.log('ğŸ·ï¸ Creating label elements...');
                const shortNameNodes = nodes.filter(d => d.name.length <= 4);
                console.log(`ğŸ“ Will create labels for ${shortNameNodes.length} short-name nodes`);
                
                const labelElements = svg.append('g')
                    .attr('class', 'labels')
                    .selectAll('text')
                    .data(shortNameNodes)
                    .enter().append('text')
                    .attr('class', 'node-label')
                    .text(d => d.name)
                    .style('font-size', '8px');
                
                console.log(`âœ… Successfully created ${labelElements.size()} labels`);
                
                // Update positions on each tick
                console.log('ğŸ”„ Setting up animation update function...');
                let tickCount = 0;
                simulation.on('tick', () => {
                    tickCount++;
                    
                    linkElements
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    nodeElements
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    labelElements
                        .attr('x', d => d.x)
                        .attr('y', d => d.y + 15);
                    
                    // Log only first few ticks
                    if (tickCount <= 5) {
                        console.log(`ğŸ”„ Tick ${tickCount}: Position update completed`);
                    }
                });
                
                console.log('âœ… Visualization creation completed!');
                
            } catch (error) {
                console.error('âŒ Error occurred during visualization creation:', error);
                throw error;
            }
        }
        
        // Create drag behavior for nodes
        function createDragBehavior() {
            return d3.drag()
                .on('start', function(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                })
                .on('drag', function(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                })
                .on('end', function(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                });
        }
        
        // Show tooltip on hover
        function showTooltip(event, d) {
            const tooltip = d3.select('.tooltip');
            const connectedLinks = links.filter(link => 
                link.source.id === d.id || link.target.id === d.id
            );
            
            tooltip.transition().duration(200).style('opacity', 1);
            tooltip.html(`
                <strong>${d.name}</strong><br/>
                é¡å‹: ${getTypeLabel(d.type)}<br/>
                é€£æ¥æ•¸: ${connectedLinks.length}
            `)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        }
        
        // Hide tooltip
        function hideTooltip() {
            d3.select('.tooltip').transition().duration(200).style('opacity', 0);
        }
        
        // Get Chinese type label
        function getTypeLabel(type) {
            const labels = {
                person: 'äººç‰©',
                location: 'åœ°é»',
                literature: 'æ–‡å­¸ä½œå“',
                concept: 'æ¦‚å¿µ',
                other: 'å…¶ä»–'
            };
            return labels[type] || 'æœªçŸ¥';
        }
        
        // Update statistics display
        function updateStats() {
            console.log('ğŸ“Š Updating statistics...');
            
            try {
                const statsElement = document.getElementById('stats');
                if (!statsElement) {
                    console.error('âŒ Cannot find statistics display element');
                    return;
                }
                
                const entityCounts = {
                    person: nodes.filter(n => n.type === 'person').length,
                    location: nodes.filter(n => n.type === 'location').length,
                    literature: nodes.filter(n => n.type === 'literature').length,
                    concept: nodes.filter(n => n.type === 'concept').length,
                    other: nodes.filter(n => n.type === 'other').length
                };
                
                console.log('ğŸ“ˆ Entity type statistics:', entityCounts);
                
                const statsText = `å¯¦é«”: ${nodes.length} | é—œä¿‚: ${links.length} | äººç‰©: ${entityCounts.person} | åœ°é»: ${entityCounts.location} | æ–‡å­¸ä½œå“: ${entityCounts.literature}`;
                statsElement.textContent = statsText;
                
                console.log('âœ… Statistics updated:', statsText);
                
            } catch (error) {
                console.error('âŒ Error occurred while updating statistics:', error);
            }
        }
        
        // Control functions
        function restartSimulation() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }
        
        function pauseResume() {
            if (simulation) {
                isPaused = !isPaused;
                if (isPaused) {
                    simulation.stop();
                } else {
                    simulation.restart();
                }
            }
        }
        
        function centerView() {
            if (svg) {
                svg.transition().duration(750).call(
                    d3.zoom().transform,
                    d3.zoomIdentity
                );
            }
        }
        
        // Initialize when page loads
        window.onload = function() {
            console.log('ğŸ” Checking D3.js loading status...');
            if (checkD3()) {
                initWhenReady();
            }
        };
    </script>
</body>
</html> 